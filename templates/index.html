<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Unlocker Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/donate.css') }}">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .feature-card {
            transition: all 0.3s ease;
        }
        .file-item {
            transition: all 0.2s ease;
        }
        .file-item:hover {
            background-color: #f3f4f6;
        }
        #dropZone.active {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .logo-text {
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
            transition: width 0.3s ease;
        }
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .debug-panel h5 {
            color: #dc3545;
            margin-bottom: 10px;
        }
        
        .debug-panel pre {
            background-color: #343a40;
            color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-btn {
            margin-top: 10px;
            color: #fff;
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #2196F3;
        }

        .btn:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="bg-indigo-600 w-full">
        <div class="container mx-auto px-4 py-3 text-center">
            <p class="text-white text-sm md:text-base">
                <span class="font-bold bg-yellow-500 text-indigo-900 px-2 py-1 rounded-md mr-2">BETA</span>
                This is a beta version of PDF Unlocker Pro. If you find any issues or have suggestions, please email
                <a href="mailto:tqui267@gmail.com" class="font-bold underline hover:text-indigo-100">tqui267@gmail.com</a>
            </p>
        </div>
    </div>
    <header class="gradient-bg py-4 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-unlock-alt text-white text-3xl mr-3"></i>
                <h1 class="text-2xl font-bold text-white">PDF Unlocker Pro</h1>
            </div>
            <nav class="hidden md:block">
                <ul class="flex space-x-6">
                    <li><a href="#features" class="text-white hover:text-gray-200 transition-colors">Features</a></li>
                    <li><a href="#how-it-works" class="text-white hover:text-gray-200 transition-colors">How It Works</a></li>
                    <li><a href="#faq" class="text-white hover:text-gray-200 transition-colors">FAQ</a></li>
                    <li><a href="#" id="donateBtn" class="text-white bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded-lg transition-colors">Donate</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <section class="max-w-4xl mx-auto">
            <div class="text-center mb-12 animate__animated animate__fadeIn">
                <h2 class="text-5xl font-extrabold mb-4 logo-text">Unlock Your PDFs</h2>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">Remove restrictions from your PDF files instantly. Unlock copy, edit, and print capabilities with just a few clicks.</p>
                <p class="text-sm text-gray-500 mt-4 max-w-2xl mx-auto bg-blue-50 p-3 rounded-lg inline-block">
                    <i class="fas fa-graduation-cap mr-1"></i> Created by <span class="font-bold">Just TTQ</span> with AI assistance. This tool is intended for educational purposes.
                </p>
            </div>
            
            <div class="bg-white rounded-xl shadow-xl p-8 mb-16 animate__animated animate__fadeInUp">
                <div class="text-center mb-8">
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-10 transition-all duration-300" id="dropZone">
                        <i class="fas fa-file-pdf text-5xl text-blue-500 mb-4"></i>
                        <p class="text-xl text-gray-600 mb-4">Drag and drop your PDF files here</p>
                        <p class="text-gray-500 mb-6">or</p>
                        <label class="inline-block">
                            <span class="gradient-bg text-white px-8 py-3 rounded-lg cursor-pointer hover:opacity-90 transition-colors shadow-md">
                                Browse Files
                            </span>
                            <input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
                        </label>
                        <p class="text-sm text-gray-500 mt-4">Max file size: 16MB</p>
                    </div>
                </div>

                <div id="uploadStatus" class="hidden mb-6 text-center">
                    <p class="text-gray-700 mb-2">Uploading files... <span id="uploadProgress">0%</span></p>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="fileList" class="space-y-3 max-h-60 overflow-y-auto mb-6 px-1"></div>

                <div class="text-center">
                    <button id="unlockBtn" class="gradient-bg text-white text-lg px-10 py-4 rounded-lg shadow-md hover:opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="unlockPDFs()">
                        <i class="fas fa-unlock-alt mr-2"></i> Unlock PDFs
                    </button>
                    <p id="processingMessage" class="hidden mt-4 text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Processing your files...
                    </p>
                </div>
                
                <!-- Download history section -->
                <div id="downloadHistory" class="mt-8 hidden border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-700">Processed Files</h4>
                        <div class="flex space-x-3">
                            <button id="downloadAllBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded-lg transition-colors shadow-sm flex items-center" title="Download all files as a single ZIP archive">
                                <i class="fas fa-download mr-1"></i> Download All
                            </button>
                            <button id="emergencyResetBtn" class="bg-red-100 hover:bg-red-200 text-red-700 text-xs px-2 py-1 rounded-lg transition-colors shadow-sm flex items-center">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Reset
                            </button>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-1"></i> 
                        <span>Click <strong>Download</strong> for individual files. Use <strong>Download All</strong> to get all files in a single ZIP archive.</span>
                    </div>
                    <div id="downloadLinks" class="space-y-2">
                        <!-- Download links will be added here -->
                    </div>
                </div>
            </div>
            
            <section id="features" class="mb-16">
                <h3 class="text-3xl font-bold text-center mb-10">Key Features</h3>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="feature-card bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center mr-4">
                                <i class="fas fa-lock-open text-white text-xl"></i>
                            </div>
                            <h4 class="text-xl font-semibold">Remove Restrictions</h4>
                        </div>
                        <p class="text-gray-600">Unlock secured PDFs to enable copying, editing, printing, and all other functions.</p>
                    </div>
                    <div class="feature-card bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center mr-4">
                                <i class="fas fa-file-alt text-white text-xl"></i>
                            </div>
                            <h4 class="text-xl font-semibold">Clean Filenames</h4>
                        </div>
                        <p class="text-gray-600">Automatically removes "(SECURED)" and similar labels from your filenames.</p>
                    </div>
                    <div class="feature-card bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center mr-4">
                                <i class="fas fa-shield-alt text-white text-xl"></i>
                            </div>
                            <h4 class="text-xl font-semibold">Secure Processing</h4>
                        </div>
                        <p class="text-gray-600">Your files are processed locally and never stored on external servers.</p>
                    </div>
                </div>
            </section>
            
            <section id="how-it-works" class="mb-16">
                <h3 class="text-3xl font-bold text-center mb-10">How It Works</h3>
                <div class="flex flex-col md:flex-row justify-between items-center space-y-8 md:space-y-0 md:space-x-8">
                    <div class="flex-1 text-center p-6">
                        <div class="w-16 h-16 rounded-full gradient-bg flex items-center justify-center mx-auto mb-4">
                            <span class="text-white font-bold text-xl">1</span>
                        </div>
                        <h4 class="text-xl font-semibold mb-3">Upload Files</h4>
                        <p class="text-gray-600">Select your secured PDF files by dragging and dropping or browsing.</p>
                    </div>
                    <div class="flex-1 text-center p-6">
                        <div class="w-16 h-16 rounded-full gradient-bg flex items-center justify-center mx-auto mb-4">
                            <span class="text-white font-bold text-xl">2</span>
                        </div>
                        <h4 class="text-xl font-semibold mb-3">Process</h4>
                        <p class="text-gray-600">Click "Unlock PDFs" and let our tool remove all restrictions.</p>
                    </div>
                    <div class="flex-1 text-center p-6">
                        <div class="w-16 h-16 rounded-full gradient-bg flex items-center justify-center mx-auto mb-4">
                            <span class="text-white font-bold text-xl">3</span>
                        </div>
                        <h4 class="text-xl font-semibold mb-3">Download</h4>
                        <p class="text-gray-600">Get your unrestricted PDF files with clean filenames.</p>
                    </div>
                </div>
            </section>
            
            <section id="faq" class="mb-12">
                <h3 class="text-3xl font-bold text-center mb-10">Frequently Asked Questions</h3>
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold mb-2">Is this process secure?</h4>
                        <p class="text-gray-600">Yes, all files are processed locally on your device. We do not store or send your PDFs to any external server.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold mb-2">Will the PDF content remain the same?</h4>
                        <p class="text-gray-600">Yes, the content of your PDF will not be altered. Only the security restrictions are removed.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold mb-2">What types of restrictions can be removed?</h4>
                        <p class="text-gray-600">Our tool can remove copy restrictions, print restrictions, edit restrictions, and other security features.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                        <h4 class="text-xl font-semibold mb-2">Am I allowed to unlock any PDF?</h4>
                        <p class="text-gray-600">You should only unlock PDFs that you have legitimate rights to modify. For students, this typically includes educational materials you need to annotate for study, PDFs that you've created yourself, PDFs where you have explicit permission from the creator, or PDFs that are not subject to copyright restrictions.</p>
                        <p class="text-gray-600 mt-2">Using this tool to bypass security on protected documents without proper authorization may violate copyright laws and other regulations. Users are solely responsible for ensuring their use of this tool complies with applicable laws.</p>
                    </div>
                    <!-- Additional FAQ entry about educational use -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                        <h4 class="text-xl font-semibold mb-2">Who created this tool?</h4>
                        <p class="text-gray-600">PDF Unlocker Pro was created by students as an educational project. It was developed to help fellow students and educators access and interact with educational materials more effectively for legitimate learning purposes.</p>
                        <p class="text-gray-600 mt-2">This tool is provided for educational purposes only and is not intended for commercial use or distribution.</p>
                    </div>
                </div>
            </section>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <i class="fas fa-unlock-alt text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">PDF Unlocker Pro</h2>
                    </div>
                    <p class="text-gray-400 mt-2">© 2025 PDF Unlocker. All rights reserved.</p>
                    <p class="text-gray-500 text-xs mt-1">Created by <span class="text-yellow-400 font-semibold">Just TTQ</span> with AI assistance</p>
                </div>
                
                <div class="mb-4 md:mb-0 text-center text-gray-400 text-sm">
                    <p>This tool is provided under the <a href="https://opensource.org/licenses/MIT" class="text-blue-400 hover:underline">MIT License</a>.</p>
                    <p class="mt-2">Use for legitimate academic and learning purposes. Ensure you have the right to modify the PDF files you process.</p>
                </div>
                
                <div>
                    <ul class="flex space-x-6">
                        <li><a href="https://github.com/TranQui004" id="githubLink" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-github"></i></a></li>
                        <li><a href="https://x.com/TranQui004" id="twitterLink" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-twitter"></i></a></li>
                        <li><a href="mailto:tqui267@gmail.com" id="emailLink" class="text-gray-300 hover:text-white transition-colors"><i class="fas fa-envelope"></i></a></li>
                        <li>
                            <button id="showDisclaimerBtn" class="text-gray-300 hover:text-white transition-colors flex items-center">
                                <i class="fas fa-info-circle mr-1"></i> Legal Disclaimer
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- Add this modal HTML right before the </body> tag -->
    <div id="resetModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full animate__animated animate__fadeInDown">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl"></i>
                <h3 class="text-xl font-bold mt-2">Reset Application</h3>
            </div>
            <p class="text-gray-600 mb-6 text-center">
                This will delete all current files and start over. Are you sure you want to continue?
            </p>
            <div class="flex justify-center space-x-4">
                <button id="resetCancelBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="resetConfirmBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white text-gray-800 rounded-lg shadow-xl p-6 max-w-2xl w-full animate__animated animate__fadeInUp" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-balance-scale text-blue-500 mr-2"></i>
                    Legal Disclaimer
                </h3>
                <button id="closeDisclaimerBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto pr-2" style="flex: 1;">
                <div class="space-y-4">
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">Educational Purpose</h4>
                        <p class="text-gray-600">
                            PDF Unlocker Pro was created by students as an educational project. It is designed to support academic activities by helping students access educational materials for legitimate learning purposes. This tool is not intended for any commercial use or copyright infringement.
                        </p>
                    </section>
                    
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">Intended Use</h4>
                        <p class="text-gray-600">
                            PDF Unlocker Pro is designed to help users, especially students, remove restrictions from PDF files they have legitimate rights to modify. This includes educational materials you need to annotate, highlight or quote for study purposes, PDFs you've personally created, or documents where you have explicit permission.
                        </p>
                    </section>
                    
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">Prohibited Use</h4>
                        <p class="text-gray-600">
                            Using this tool to bypass security measures on protected documents without proper authorization may constitute copyright infringement and could violate local, national, and international laws and regulations regarding intellectual property and document security.
                        </p>
                    </section>
                    
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">No Warranty</h4>
                        <p class="text-gray-600">
                            This software is provided "as is" without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose, and non-infringement. In no event shall the authors, copyright holders, or distributors be liable for any claim, damages, or other liability, whether in an action of contract, tort, or otherwise, arising from, out of, or in connection with the software or the use or other dealings in the software.
                        </p>
                    </section>
                    
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">User Responsibility</h4>
                        <p class="text-gray-600">
                            By using PDF Unlocker Pro, you acknowledge that you are solely responsible for ensuring your use complies with all applicable laws regarding document modification, copyright protection, intellectual property rights, and any contractual obligations that may apply to the documents you process.
                        </p>
                    </section>
                    
                    <section>
                        <h4 class="font-semibold text-gray-700 mb-2">Data Protection</h4>
                        <p class="text-gray-600">
                            While PDF Unlocker Pro processes all files locally on your device and does not transmit your documents to external servers, you remain responsible for protecting sensitive data contained within your PDFs and ensuring you have proper authorization to access and modify such data.
                        </p>
                    </section>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                <button id="acceptDisclaimerBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closePasswordModal">&times;</span>
            <h4 id="passwordModalTitle">Password Required</h4>
            <p>This PDF is password-protected. Please enter the password to unlock it.</p>
            <div class="form-group">
                <input type="password" id="passwordInput" class="form-control" placeholder="Enter password">
            </div>
            <div class="flex space-x-2">
                <button id="submitPasswordBtn" class="btn btn-primary">Unlock PDF</button>
                <button id="tryPasswordBtn" class="btn debug-btn">Try Common Passwords</button>
                <button id="cancelPasswordBtn" class="btn">Cancel</button>
            </div>
            
            <!-- Debug section (only visible after failed attempts) -->
            <div id="debugContainer" class="debug-panel">
                <h5>Debug Information</h5>
                <pre id="debugOutput">No debug information available.</pre>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const unlockBtn = document.getElementById('unlockBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const progressBar = document.getElementById('progressBar');
        const uploadProgress = document.getElementById('uploadProgress');
        const processingMessage = document.getElementById('processingMessage');
        let files = [];
        
        // Object to track files that need passwords
        const passwordProtectedFiles = {};
        
        // Common passwords for the Try Common Passwords feature
        const commonPasswords = [
            "", // Empty password
            "password",
            "123456",
            "12345678",
            "1234",
            "qwerty",
            "admin",
            "welcome",
            "abc123",
            "test",
            "123",
            "1",
            "0",
            "default",
            "user",
            "pass",
            "adobe",
            "pdf"
        ];
        
        let tryPasswordAttempts = 0;
        let modalActive = false;

        // Track download history
        const downloadHistory = document.getElementById('downloadHistory');
        const downloadLinks = document.getElementById('downloadLinks');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const emergencyResetBtn = document.getElementById('emergencyResetBtn');
        let processedFiles = [];

        // Variables for tracking upload and download state
        let uploadedFiles = [];
        let downloadedFiles = [];
        let processedCount = 0;
        let isPreviewing = false;
        let progressInterval;

        // Function to clean filename by removing "(SECURED)" text and similar variations
        function cleanFilename(filename) {
            // Remove common security indicators like (SECURED), [SECURED], [PROTECTED], etc.
            let cleaned = filename.replace(/\s*[\(\[](?:SECURED|PROTECTED|LOCKED|READONLY)[\)\]]\s*/gi, '');
            
            // Remove "unlocked_" prefix if present
            if (cleaned.startsWith("unlocked_")) {
                cleaned = cleaned.substring(9);
            }
            
            return cleaned;
        }

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            
            if (droppedFiles.length === 0) {
                showNotification('Please upload PDF files only', 'error');
                return;
            }
            
            handleFiles(droppedFiles);
            animateDroppedFiles();
        });

        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Clear file input to allow re-uploading the same file
            this.value = '';
            
            handleFiles(files);
        });

        function animateDroppedFiles() {
            dropZone.classList.add('animate__animated', 'animate__pulse');
            setTimeout(() => {
                dropZone.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
        }

        function handleFiles(newFiles) {
            // Check if files exceed the maximum size
            const oversizedFiles = newFiles.filter(file => file.size > 16 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                showNotification('Some files exceed the 16MB limit and were not added.', 'error');
                newFiles = newFiles.filter(file => file.size <= 16 * 1024 * 1024);
            }
            
            // Detect password-protected PDFs immediately when added
            newFiles.forEach(async file => {
                try {
                    // Create a temporary FormData to check if the file is password-protected
                    const formData = new FormData();
                    formData.append('files[]', file);
                    
                    // Send to server just to check if password is needed
                    const response = await fetch('/check-password', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Lưu file_id bất kể file có cần mật khẩu hay không
                        if (result.file_id) {
                            file.fileId = result.file_id;
                        }
                        
                        if (result.needs_password) {
                            // Mark the file as password-protected
                            file.passwordProtected = true;
                            
                            // Update the file list to show password protection indicator
                            updateFileList();
                            
                            // Notify the user
                            showNotification(`"${file.name}" is password-protected.`, 'info');
                        }
                    }
                } catch (error) {
                    console.error('Error checking password:', error);
                }
            });
            
            files = [...files, ...newFiles];
            updateFileList();
            unlockBtn.disabled = files.length === 0;
        }

        // Improved notification system to prevent overlapping and show immediately
        const notificationContainer = document.createElement('div');
        notificationContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col-reverse gap-2';
        document.body.appendChild(notificationContainer);

        let notificationQueue = [];
        let isShowingNotification = false;

        function showNotification(message, type = 'info') {
            // Create notification element immediately
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-lg animate__animated animate__fadeInUp max-w-md mb-2 flex items-center`;
            
            if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
            } else if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
                notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
            }
            
            // Add to DOM immediately
            notificationContainer.appendChild(notification);
            
            // Fade out and remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('animate__fadeInUp');
                notification.classList.add('animate__fadeOutRight');
                setTimeout(() => {
                    if (notification.parentNode === notificationContainer) {
                        notificationContainer.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        // Function to clear all files from display and storage
        function clearAllFiles() {
            files = [];
            updateFileList();
            unlockBtn.disabled = true;
        }
        
        // Clear file list display if empty
        function checkEmptyFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '';
                unlockBtn.disabled = true;
            }
        }
        
        // Update the updateFileList function to check for empty state
        function updateFileList() {
            fileList.innerHTML = '';
            
            if (files.length === 0) {
                return;
            }
            
            files.forEach((file, index) => {
                // Clean the displayed filename
                const displayName = cleanFilename(file.name);
                
                // Create file item element
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item flex items-center justify-between bg-gray-50 p-4 rounded-lg';
                
                // Add file ID if it exists (for password protected files)
                if (file.fileId) {
                    fileItem.dataset.fileId = file.fileId;
                }
                
                fileItem.innerHTML = `
                    <div class="flex items-center flex-1 overflow-hidden">
                        <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                        <div class="overflow-hidden">
                            <span class="text-gray-800 font-medium block truncate" title="${displayName}">${displayName}</span>
                            <span class="text-gray-500 text-sm">${formatFileSize(file.size)}</span>
                            ${file.passwordProtected ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded ml-2">Password Protected</span>' : ''}
                            ${file.hasError ? `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded ml-2">Error</span>` : ''}
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition-colors ml-4" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileList.appendChild(fileItem);
                
                // Add animation
                setTimeout(() => {
                    fileItem.classList.add('animate__animated', 'animate__fadeIn');
                }, index * 100);
            });
            
            // Update the unlock button state
            unlockBtn.disabled = files.length === 0;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(index) {
            const fileItem = fileList.children[index];
            fileItem.classList.remove('animate__fadeIn');
            fileItem.classList.add('animate__fadeOut');
            
            setTimeout(() => {
                files.splice(index, 1);
                updateFileList();
                unlockBtn.disabled = files.length === 0;
            }, 300);
        }

        function unlockPDFs() {
            if (files.length === 0) {
                notification('Please select at least one PDF file', 'error');
                return;
            }
            
            // Show processing message
            processingMessage.classList.remove('hidden');
            unlockBtn.disabled = true;
            
            // Show upload progress
            uploadStatus.classList.remove('hidden');
            
            // Simulate upload progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = `${progress}%`;
                uploadProgress.textContent = `${Math.round(progress)}%`;
                
                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        uploadStatus.classList.add('hidden');
                    }, 500);
                }
            }, 200);
            
            // Chia tệp thành 2 nhóm: tệp có password và tệp không có password
            const passwordFiles = files.filter(file => file.passwordProtected);
            const regularFiles = files.filter(file => !file.passwordProtected);
            
            // Kiểm tra nếu tất cả các file đều cần password
            if (regularFiles.length === 0 && passwordFiles.length > 0) {
                clearInterval(interval);
                uploadStatus.classList.add('hidden');
                processingMessage.classList.add('hidden');
                unlockBtn.disabled = false;
                
                // Hiển thị hộp thoại yêu cầu mật khẩu cho file đầu tiên
                if (passwordFiles[0].fileId) {
                    showPasswordModal(passwordFiles[0].fileId, passwordFiles[0].name);
                }
                return;
            }
            
            // Tạo danh sách các file cần xử lý (không cần password)
            const formData = new FormData();
            
            // Thêm cả regular files và files có fileId nhưng không passwordProtected
            regularFiles.forEach(file => {
                if (file.fileId) {
                    // Nếu file đã có fileId (đã được tải lên), chỉ cần gửi thông tin fileId
                    formData.append('file_ids[]', file.fileId);
                } else {
                    // Nếu không, gửi file để upload
                    formData.append('files[]', file);
                }
            });
            
            // Gửi request đến server
            fetch('/unlock', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(results => {
                console.log("Server response:", results); // Debug information
                
                let successCount = 0;
                let errorCount = 0;
                let passwordCount = 0;
                let processedFileIds = []; // Track which files were processed
                
                // Xử lý kết quả
                results.forEach(result => {
                    const file = files.find(f => f.name === result.filename || 
                                              (result.file_id && f.fileId === result.file_id));
                    
                    if (result.status === 'success') {
                        successCount++;
                        // Thêm vào danh sách file đã xử lý
                        processedFiles.push({
                            filename: result.filename,
                            url: result.download_url
                        });
                        
                        // Add to list of processed file IDs
                        if (file && file.fileId) {
                            processedFileIds.push(file.fileId);
                        }
                        
                        // Đánh dấu file này đã được xử lý để xóa khỏi danh sách
                        if (file) file.processed = true;
                    } else if (result.status === 'needs_password') {
                        passwordCount++;
                        
                        // Lưu file_id và đánh dấu file cần password
                        if (file) {
                            file.fileId = result.file_id;
                            file.passwordProtected = true;
                        }
                        
                        // Lưu vào từ điển file cần mật khẩu
                        passwordProtectedFiles[result.file_id] = result.filename;
                    } else {
                        errorCount++;
                        // Đánh dấu file có lỗi
                        if (file) {
                            file.hasError = true;
                            file.errorMessage = result.message;
                        }
                        
                        showNotification(`Error processing file: ${result.message}`, 'error');
                    }
                });
                
                console.log("Files before filtering:", [...files]);
                
                // Xóa các file đã xử lý thành công khỏi danh sách - method 1
                files = files.filter(file => !file.processed);
                
                // Additional forceful method to remove processed files - method 2
                if (processedFileIds.length > 0) {
                    files = files.filter(file => !processedFileIds.includes(file.fileId));
                }
                
                // If any files were successfully processed, make sure to force UI update
                if (successCount > 0) {
                    // Force clear files that were just unlocked but might still be in array
                    const filesToRemove = [];
                    for (let i = 0; i < files.length; i++) {
                        if (!files[i].passwordProtected && !files[i].hasError) {
                            filesToRemove.push(i);
                        }
                    }
                    
                    // Remove from end to beginning to avoid index issues
                    for (let i = filesToRemove.length - 1; i >= 0; i--) {
                        files.splice(filesToRemove[i], 1);
                    }
                }
                
                console.log("Files after filtering:", [...files]);
                
                // Cập nhật giao diện
                updateFileList();
                updateDownloadHistory();
                
                // Hiển thị hộp thoại nhập mật khẩu cho file cần mật khẩu đầu tiên
                const passwordFiles = files.filter(file => file.passwordProtected && file.fileId);
                if (passwordFiles.length > 0) {
                    showPasswordModal(passwordFiles[0].fileId, passwordFiles[0].name);
                }
                
                // Hiển thị thông báo
                if (successCount > 0) {
                    showNotification(`Successfully unlocked ${successCount} file(s)!`, 'success');
                }
                
                if (passwordCount > 0) {
                    showNotification(`${passwordCount} file(s) require a password to unlock.`, 'warning');
                }
                
                if (errorCount > 0) {
                    showNotification(`Failed to process ${errorCount} file(s).`, 'error');
                }
            })
            .catch(error => {
                console.error('Processing error:', error);
                showNotification(`An error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                clearInterval(interval);
                progressBar.style.width = '0%';
                uploadStatus.classList.add('hidden');
                unlockBtn.disabled = files.length === 0;
                processingMessage.classList.add('hidden');
            });
        }

        function updateDownloadHistory() {
            if (processedFiles.length === 0) {
                downloadHistory.classList.add('hidden');
                return;
            }
            
            downloadHistory.classList.remove('hidden');
            downloadLinks.innerHTML = '';
            
            processedFiles.forEach((file, index) => {
                const linkItem = document.createElement('div');
                linkItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg animate__animated animate__fadeIn';
                linkItem.innerHTML = `
                    <div class="flex items-center flex-1 overflow-hidden">
                        <i class="fas fa-file-pdf text-green-500 mr-3"></i>
                        <span class="text-gray-800 truncate" title="${file.filename}">${file.filename}</span>
                    </div>
                    <div class="flex items-center">
                        <a href="${file.url}" download class="text-blue-500 hover:text-blue-700 transition-colors px-3 py-1 flex items-center">
                            <i class="fas fa-download mr-1"></i> Download
                        </a>
                        <button class="text-gray-400 hover:text-red-500 transition-colors ml-2" onclick="removeFromHistory(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                downloadLinks.appendChild(linkItem);
            });
        }

        function removeFromHistory(index) {
            processedFiles.splice(index, 1);
            updateDownloadHistory();
            showNotification('File removed from list', 'info');
        }

        // Handle "Download All" button
        downloadAllBtn.addEventListener('click', async () => {
            if (processedFiles.length === 0) return;
            
            // Show a confirmation dialog if there are multiple files
            if (processedFiles.length > 1) {
                const confirmed = confirm(`Download All will create a ZIP file containing all ${processedFiles.length} unlocked PDF files. Continue?`);
                if (!confirmed) return;
            }
            
            try {
                showNotification('Preparing ZIP archive for download...', 'info');
                
                // Create a list of file URLs to download
                const fileUrls = processedFiles.map(file => file.url);
                
                // Call the API to create a ZIP archive
                const response = await fetch('/download-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files: fileUrls })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create archive');
                }
                
                const result = await response.json();
                
                // Show success notification
                showNotification('ZIP archive created successfully! Starting download...', 'success');
                
                // Download the ZIP file
                setTimeout(() => {
                    window.location.href = result.download_url;
                }, 1000);
                
            } catch (error) {
                console.error('Download all error:', error);
                showNotification('Failed to create download archive. Try downloading files individually.', 'error');
            }
        });

        // Handle emergency reset - replace the existing event listener
        emergencyResetBtn.addEventListener('click', () => {
            // Show the custom modal instead of browser confirm
            document.getElementById('resetModal').classList.remove('hidden');
        });

        // Add event listeners for the modal buttons
        document.getElementById('resetCancelBtn').addEventListener('click', () => {
            document.getElementById('resetModal').classList.add('hidden');
        });

        document.getElementById('resetConfirmBtn').addEventListener('click', async () => {
            try {
                // Hide the modal
                document.getElementById('resetModal').classList.add('hidden');
                
                // Process the reset without showing any notification
                const response = await fetch('/emergency-reset', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Clear the processed files array
                    processedFiles.length = 0;
                    updateDownloadHistory();
                    
                    // Clear any remaining files in the upload list
                    files = [];
                    updateFileList();
                    unlockBtn.disabled = true;
                    
                    // Hide sections if they were visible
                    downloadHistory.classList.add('hidden');
                    
                    // No success notification
                } else {
                    throw new Error('Server error during reset');
                }
            } catch (error) {
                console.error('Reset error:', error);
                // Only show notification for errors, not for success
                showNotification(`Reset failed: ${error.message}. Try again.`, 'error');
            }
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                
                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Initialize UI properly when loading the page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check for existing processed files
                const response = await fetch('/get-processed-files');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        // We have processed files, add them to the list
                        processedFiles = data.files.map(file => ({
                            filename: file.display_name,
                            url: file.download_url
                        }));
                        
                        // Update the download history UI
                        updateDownloadHistory();
                        console.log('Loaded existing processed files:', processedFiles.length);
                    } else {
                        console.log('No existing processed files found');
                        downloadHistory.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error checking for existing files:', error);
            }
        });

        // Disclaimer Modal Script
        const showDisclaimerBtn = document.getElementById('showDisclaimerBtn');
        const closeDisclaimerBtn = document.getElementById('closeDisclaimerBtn');
        const acceptDisclaimerBtn = document.getElementById('acceptDisclaimerBtn');
        const disclaimerModal = document.getElementById('disclaimerModal');
        
        showDisclaimerBtn.addEventListener('click', () => {
            disclaimerModal.classList.remove('hidden');
        });
        
        function closeDisclaimerModal() {
            disclaimerModal.querySelector('.bg-white').classList.remove('animate__fadeInUp');
            disclaimerModal.querySelector('.bg-white').classList.add('animate__fadeOutDown');
            
            setTimeout(() => {
                disclaimerModal.classList.add('hidden');
                disclaimerModal.querySelector('.bg-white').classList.remove('animate__fadeOutDown');
                disclaimerModal.querySelector('.bg-white').classList.add('animate__fadeInUp');
            }, 500);
        }
        
        closeDisclaimerBtn.addEventListener('click', closeDisclaimerModal);
        acceptDisclaimerBtn.addEventListener('click', closeDisclaimerModal);
        
        // Close on click outside the modal content
        disclaimerModal.addEventListener('click', (e) => {
            if (e.target === disclaimerModal) {
                closeDisclaimerModal();
            }
        });

        // Copy to clipboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            const clipboardButtons = document.querySelectorAll('.copy-to-clipboard');
            
            clipboardButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const textToCopy = this.getAttribute('data-clipboard');
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // Store original text
                        const originalText = this.innerHTML;
                        
                        // Change text to indicate copying
                        this.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                        
                        // Revert back after 2 seconds
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                        
                        showNotification('Copied to clipboard!', 'success');
                    }, (err) => {
                        console.error('Could not copy text: ', err);
                        showNotification('Failed to copy text', 'error');
                    });
                });
            });

            // Setup social media links
            if (window.PAYMENT_INFO && window.decryptInfo) {
                try {
                    // GitHub link
                    const githubLink = document.getElementById('githubLink');
                    if (githubLink) {
                        githubLink.href = 'https://github.com/TranQui004';
                        githubLink.target = '_blank';
                        githubLink.rel = 'noopener noreferrer';
                    }
                    
                    // Twitter link
                    const twitterLink = document.getElementById('twitterLink');
                    if (twitterLink && window.PAYMENT_INFO.twitter) {
                        twitterLink.href = window.decryptInfo(window.PAYMENT_INFO.twitter);
                        twitterLink.target = '_blank';
                        twitterLink.rel = 'noopener noreferrer';
                    }
                    
                    // Email link
                    const emailLink = document.getElementById('emailLink');
                    if (emailLink && window.PAYMENT_INFO.email) {
                        const email = window.decryptInfo(window.PAYMENT_INFO.email);
                        emailLink.href = `mailto:${email}`;
                    }
                } catch (error) {
                    console.error('Error setting up social links:', error);
                }
            }
        });

        // Function to show password modal
        function showPasswordModal(fileId, filename) {
            console.log("Showing password modal for file:", filename, "with ID:", fileId);
            if (!fileId) return;
            
            // Set the file ID on the unlock button
            const submitPasswordBtn = document.getElementById('submitPasswordBtn');
            submitPasswordBtn.setAttribute('data-file-id', fileId);
            console.log("Set file ID attribute on unlock button:", submitPasswordBtn.getAttribute('data-file-id'));
            
            // Set the filename in the modal title
            const modalTitle = document.getElementById('passwordModalTitle');
            modalTitle.textContent = `Enter password for ${filename}`;
            
            // Clear any previous password
            document.getElementById('passwordInput').value = '';
            
            // Hide the debug container initially
            const debugContainer = document.getElementById('debugContainer');
            if (debugContainer) {
                debugContainer.style.display = 'none';
            }
            
            // Make sure the Try Password button is visible and not disabled
            const tryPasswordBtn = document.getElementById('tryPasswordBtn');
            if (tryPasswordBtn) {
                tryPasswordBtn.style.display = 'inline-block';
                tryPasswordBtn.disabled = false;
                tryPasswordBtn.textContent = 'Try Common Passwords';
            }
            
            // Reset attempts counter
            tryPasswordAttempts = 0;
            
            // Show the modal
            const passwordModal = document.getElementById('passwordModal');
            passwordModal.style.display = 'block';
            modalActive = true;
            
            // Focus the password input
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }

        // Set up event listeners for password modal
        document.addEventListener('DOMContentLoaded', function() {
            // Button to submit password
            const submitPasswordBtn = document.getElementById('submitPasswordBtn');
            submitPasswordBtn.addEventListener('click', function() {
                const fileId = this.getAttribute('data-file-id');
                unlockWithPassword(fileId);
            });
            
            // Button to try common passwords
            const tryPasswordBtn = document.getElementById('tryPasswordBtn');
            tryPasswordBtn.addEventListener('click', function() {
                const fileId = document.getElementById('submitPasswordBtn').getAttribute('data-file-id');
                tryCommonPasswords(fileId);
            });
            
            // Close modal button
            const closePasswordModal = document.getElementById('closePasswordModal');
            closePasswordModal.addEventListener('click', function() {
                document.getElementById('passwordModal').style.display = 'none';
                modalActive = false;
            });
            
            // Cancel button
            const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
            cancelPasswordBtn.addEventListener('click', function() {
                document.getElementById('passwordModal').style.display = 'none';
                modalActive = false;
            });
            
            // Close modal on click outside
            window.addEventListener('click', function(event) {
                const passwordModal = document.getElementById('passwordModal');
                if (event.target === passwordModal) {
                    passwordModal.style.display = 'none';
                    modalActive = false;
                }
            });
            
            // Allow pressing Enter to submit password
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const fileId = document.getElementById('submitPasswordBtn').getAttribute('data-file-id');
                    unlockWithPassword(fileId);
                }
            });
        });

        // Try common passwords
        function tryCommonPasswords(fileId) {
            console.log("Starting tryCommonPasswords with fileId:", fileId);
            if (!fileId) {
                showNotification('No file selected', 'error');
                return;
            }
            
            // Get the filename from the modal title
            const modalTitle = document.getElementById('passwordModalTitle');
            const filename = modalTitle.textContent.replace('Enter password for ', '');
            
            // Show a progress bar in the modal for password attempts
            const debugContainer = document.getElementById('debugContainer');
            debugContainer.style.display = 'block';
            debugContainer.innerHTML = `
                <h5>Trying Common Passwords</h5>
                <div class="progress-container" style="margin: 10px 0;">
                    <div class="progress-bar" id="passwordProgressBar" style="width: 0%"></div>
                </div>
                <p id="currentPasswordText" style="font-size: 12px; margin-top: 5px;"></p>
            `;
            
            // Disable the try password button
            const tryPasswordBtn = document.getElementById('tryPasswordBtn');
            tryPasswordBtn.disabled = true;
            tryPasswordBtn.textContent = 'Trying...';
            
            // Show initial notification
            showNotification('Trying common passwords...', 'info');
            
            // Start with the first password to try
            tryPasswordAttempts = 0;
            tryPassword(fileId, tryPasswordAttempts);
        }
        
        // Try a specific password from the common passwords list
        function tryPassword(fileId, index) {
            console.log(`Trying password at index ${index} for file ${fileId}`);
            if (index >= commonPasswords.length) {
                // We've tried all passwords, enable the button and show message
                const tryPasswordBtn = document.getElementById('tryPasswordBtn');
                tryPasswordBtn.disabled = false;
                tryPasswordBtn.textContent = 'Try Common Passwords';
                
                // Reset the debug container
                const debugContainer = document.getElementById('debugContainer');
                debugContainer.innerHTML = `<h5>Debug Information</h5>
                <pre id="debugOutput">All common passwords tried without success.</pre>`;
                
                showNotification('All common passwords tried without success', 'error');
                return;
            }
            
            const password = commonPasswords[index];
            
            // Update progress bar
            const progressBar = document.getElementById('passwordProgressBar');
            const percentComplete = Math.round((index / commonPasswords.length) * 100);
            progressBar.style.width = `${percentComplete}%`;
            
            // Update current password text
            const currentPasswordText = document.getElementById('currentPasswordText');
            currentPasswordText.textContent = `Trying: "${password || '(empty)'}" (${index+1}/${commonPasswords.length})`;
            
            // Send the password to the server
            fetch('/unlock-with-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId,
                    password: password,
                    debug_info: true
                }),
            })
            .then(response => response.json())
            .then(result => {
                console.log("Password attempt result:", result);
                if (result.status === 'success') {
                    // Password worked, update UI
                    const tryPasswordBtn = document.getElementById('tryPasswordBtn');
                    tryPasswordBtn.disabled = false;
                    tryPasswordBtn.textContent = 'Try Common Passwords';
                    
                    // Add to processed files
                    processedFiles.push({
                        filename: result.filename,
                        url: result.download_url
                    });
                    
                    // Find the file in the array and mark it as processed
                    console.log("Looking for fileId in common passwords function:", fileId, "in files:", files);
                    const fileIndex = files.findIndex(file => file.fileId === fileId);
                    console.log("Found at index:", fileIndex);
                    
                    if (fileIndex !== -1) {
                        files[fileIndex].processed = true;
                        // Remove the processed file from the files array
                        files.splice(fileIndex, 1);
                    } else {
                        // Try alternative matching if fileId match fails
                        console.log("Common password success: File not found by fileId, trying backup method");
                        
                        // Filter by looking for any file with matching filename
                        const oldLength = files.length;
                        files = files.filter(file => {
                            // Keep file if we can't determine matching criteria
                            if (!result.filename) return true;
                            
                            // Remove if filename matches
                            return file.name !== result.filename;
                        });
                        
                        if (oldLength !== files.length) {
                            console.log("Removed file using backup method in common passwords function");
                        }
                    }
                    
                    // Force re-update the file list display to reflect removal
                    updateFileList();
                    checkEmptyFileList();
                    
                    // Close the modal
                    const passwordModal = document.getElementById('passwordModal');
                    if (passwordModal) {
                        passwordModal.style.display = 'none';
                    }
                    
                    // Show success notification
                    showNotification(`Successfully unlocked with password: ${password || '(empty)'}`, 'success');
                    
                    // Process the next password-protected file, if any
                    processNextPasswordFile();
                } else {
                    // Password didn't work, try the next one
                    tryPasswordAttempts = index + 1;
                    // Speed up the process by reducing delay between attempts
                    setTimeout(() => {
                        tryPassword(fileId, index + 1);
                    }, 50); // Reduced from 300ms to 50ms for faster attempts
                }
            })
            .catch(error => {
                console.error('Error trying password:', error);
                
                // Re-enable the button
                const tryPasswordBtn = document.getElementById('tryPasswordBtn');
                tryPasswordBtn.disabled = false;
                tryPasswordBtn.textContent = 'Try Common Passwords';
                
                // Reset the debug container
                const debugContainer = document.getElementById('debugContainer');
                debugContainer.innerHTML = `<h5>Debug Information</h5>
                <pre id="debugOutput">Error trying password: ${error.message}</pre>`;
                
                showNotification('Error trying password', 'error');
            });
        }

        // Process the next password-protected file
        function processNextPasswordFile() {
            console.log("Processing next password file. Current files:", files);
            
            // Force update UI first to ensure we're working with the latest state
            updateFileList();
            checkEmptyFileList();
            
            // Find the next password-protected file
            const passwordFile = files.find(file => file.passwordProtected);
            
            if (passwordFile && passwordFile.fileId) {
                console.log("Found next password-protected file:", passwordFile);
                // Show the password modal for this file
                showPasswordModal(passwordFile.fileId, passwordFile.name);
            } else {
                console.log("No more password-protected files found");
                // No more password-protected files, make sure UI is updated
                checkEmptyFileList();
                
                // If all files are processed, show a success notification
                if (files.length === 0 && processedFiles.length > 0) {
                    console.log("All files processed, showing success notification");
                    showNotification('All files have been processed successfully!', 'success');
                }
                
                // Force additional check to clear any lingering files
                if (files.length > 0) {
                    console.log("Some files still remain, checking if they should be cleared");
                    // Check if any remaining files are not password-protected and not errored
                    // If so, these should have been processed already
                    const filesToRemove = files.filter(file => !file.passwordProtected && !file.hasError);
                    if (filesToRemove.length > 0) {
                        console.log("Found files that should be cleared:", filesToRemove);
                        files = files.filter(file => file.passwordProtected || file.hasError);
                        updateFileList();
                    }
                }
            }
        }

        // Function to unlock with password
        function unlockWithPassword(fileId) {
            console.log("Attempting to unlock with password for fileId:", fileId);
            const passwordInput = document.getElementById('passwordInput');
            if (!passwordInput) {
                console.error('Password input element not found');
                return;
            }
            
            const password = passwordInput.value.trim();
            
            if (!password) {
                showNotification('Please enter a password', 'warning');
                return;
            }
            
            showNotification('Unlocking PDF...', 'info');
            
            const data = {
                file_id: fileId,
                password: password,
                debug_info: true
            };
            
            console.log("Sending unlock request with data:", data);
            
            fetch('/unlock-with-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Unlock response:", data);
                // Process the response
                if (data.status === 'success') {
                    showNotification('PDF unlocked successfully!', 'success');
                    
                    // Add to processed files
                    processedFiles.push({
                        filename: data.filename,
                        url: data.download_url
                    });
                    
                    // Update download history
                    updateDownloadHistory();
                    
                    // Close the password modal
                    const passwordModal = document.getElementById('passwordModal');
                    if (passwordModal) {
                        passwordModal.style.display = 'none';
                        modalActive = false;
                    }
                    
                    // Find the file in the array and mark it as processed
                    console.log("Looking for fileId:", fileId, "in files:", files);
                    const fileIndex = files.findIndex(file => file.fileId === fileId);
                    console.log("Found at index:", fileIndex);
                    
                    if (fileIndex !== -1) {
                        // Mark it as processed and remove it
                        files[fileIndex].processed = true;
                        
                        // Remove the processed file from the files array
                        files.splice(fileIndex, 1);
                    } else {
                        // If we didn't find it by fileId, do a broader search to ensure removal
                        console.log("File not found by fileId, trying backup removal method");
                        
                        // Filter by looking for any file with matching filename
                        const oldLength = files.length;
                        files = files.filter(file => {
                            // Don't remove if we can't match it to the processed file
                            if (!data.filename) return true;
                            
                            // Remove if filename matches
                            return file.name !== data.filename;
                        });
                        
                        if (oldLength !== files.length) {
                            console.log("Removed file using backup method");
                        }
                    }
                    
                    // Update the file list display
                    updateFileList();
                    
                    // Check for more password files to process
                    processNextPasswordFile();
                } else if (data.status === 'error') {
                    // Hide any previous debug info
                    const debugContainer = document.getElementById('debugContainer');
                    if (debugContainer) {
                        debugContainer.style.display = 'none';
                    }
                    
                    // Show error notification
                    if (data.error && data.error.includes('incorrect password')) {
                        showNotification('Incorrect password. Please try again or use "Try Common Passwords".', 'error');
                        
                        // Show the try password button after a failed attempt
                        const tryPasswordBtn = document.getElementById('tryPasswordBtn');
                        if (tryPasswordBtn) {
                            tryPasswordBtn.style.display = 'inline-block';
                            tryPasswordBtn.disabled = false;
                        }
                    } else {
                        showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while unlocking the PDF.', 'error');
            });
        }

        // Improved tab close detection
        window.addEventListener('beforeunload', function(event) {
            // Store current timestamp
            const closeTime = Date.now();
            localStorage.setItem('tabClosingTime', closeTime.toString());
            localStorage.setItem('tabClosed', 'true');
            
            // This code will run on refresh but not on tab close (no time to execute)
            setTimeout(function() {
                // If this runs, it's a page refresh, not a tab close
                localStorage.setItem('isRefresh', 'true');
            }, 1);
        });
        
        // When the page loads, check if it was a tab close or refresh
        document.addEventListener('DOMContentLoaded', function() {
            const tabClosed = localStorage.getItem('tabClosed');
            const isRefresh = localStorage.getItem('isRefresh');
            
            // Check session status
            checkSessionAndCleanIfNeeded(tabClosed, isRefresh);
            
            // Always clear the localStorage flags
            localStorage.removeItem('tabClosed');
            localStorage.removeItem('isRefresh');
            localStorage.removeItem('tabClosingTime');
        });
        
        // Check session status and clean data if needed
        async function checkSessionAndCleanIfNeeded(tabClosed, isRefresh) {
            try {
                // Check server-side session status first
                const sessionResponse = await fetch('/session-status');
                const sessionData = await sessionResponse.json();
                
                console.log('Session status:', sessionData);
                
                // If we have data and tab was closed (but not refreshed), clear everything
                if (sessionData.has_data && tabClosed === 'true' && isRefresh !== 'true') {
                    console.log('Tab was closed and reopened with existing data - clearing data');
                    
                    // Clear local files and UI
                    files = [];
                    processedFiles = [];
                    updateFileList();
                    
                    if (downloadHistory) {
                        downloadHistory.classList.add('hidden');
                    }
                    
                    // Send request to clear server-side files
                    const clearResponse = await fetch('/clear-processed', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({}),
                    });
                    
                    const clearData = await clearResponse.json();
                    console.log('Server data cleared:', clearData);
                    
                    // Show notification about data clearing
                    setTimeout(() => {
                        showNotification('Previous session data was cleared for privacy', 'info');
                    }, 1000);
                } else {
                    // If it's a refresh or no existing data, just load any existing files
                    loadExistingFiles();
                }
            } catch (error) {
                console.error('Error checking session status:', error);
                // Fall back to loading existing files if there was an error
                loadExistingFiles();
            }
        }
        
        // Load existing processed files
        async function loadExistingFiles() {
            try {
                // Check for existing processed files
                const response = await fetch('/get-processed-files');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        // We have processed files, add them to the list
                        processedFiles = data.files.map(file => ({
                            filename: file.display_name,
                            url: file.download_url
                        }));
                        
                        // Update the download history UI
                        updateDownloadHistory();
                        console.log('Loaded existing processed files:', processedFiles.length);
                    } else {
                        console.log('No existing processed files found');
                        downloadHistory.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error checking for existing files:', error);
            }
        }
    </script>
    <script src="{{ url_for('static', filename='js/payment_info.js') }}"></script>
    <script src="{{ url_for('static', filename='js/donate.js') }}"></script>
</body>
</html> 